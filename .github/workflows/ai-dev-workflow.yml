name: AI Development Assistant

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      task:
        description: 'Task to run'
        required: true
        default: 'review'

env:
  OPENAI_API_KEY: ${{ secrets.MANUS_API_KEY }}
  OPENAI_API_BASE: https://api.manus.ai/v1
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # PR REVIEW
  pr-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PR-Agent
        run: pip install pr-agent

      - name: PR-Agent Review
        run: |
          pr-agent --pr_url=${{ github.event.pull_request.html_url }} review
        env:
          OPENAI_API_KEY: ${{ secrets.MANUS_API_KEY }}
          OPENAI_API_BASE: https://api.manus.ai/v1

      - name: PR-Agent Improve
        run: |
          pr-agent --pr_url=${{ github.event.pull_request.html_url }} improve
        env:
          OPENAI_API_KEY: ${{ secrets.MANUS_API_KEY }}
          OPENAI_API_BASE: https://api.manus.ai/v1

  # ISSUE AUTO-LABEL
  issue-triage:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Auto-Label Issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = (issue.body || '').toLowerCase();
            const title = (issue.title || '').toLowerCase();

            const labels = [];
            if (title.includes('bug') || body.includes('error') || body.includes('crash')) {
              labels.push('bug');
            }
            if (title.includes('feature') || body.includes('request') || body.includes('add')) {
              labels.push('enhancement');
            }
            if (body.includes('security') || body.includes('vulnerability') || body.includes('cve')) {
              labels.push('security');
            }

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labels
              });
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `ðŸ¤– **AI Assistant**: Analyzing this issue...\n\nLabels: ${labels.join(', ') || 'analyzing...'}\n\n_I'll work on this automatically if it's a bug, feature request, or security issue._`
            });

  # AUTO-FIX BUGS
  auto-fix-bug:
    if: github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'bug'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Analyze Project Context
        id: context
        run: |
          echo "## Project Analysis" > /tmp/project-context.md
          echo "" >> /tmp/project-context.md

          # Check if repo has code
          FILE_COUNT=$(find . -type f \( -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.go" -o -name "*.rs" -o -name "*.java" -o -name "*.cpp" -o -name "*.c" -o -name "*.sol" \) | head -100 | wc -l)
          echo "has_code=$([[ $FILE_COUNT -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

          echo "### Repository: ${{ github.repository }}" >> /tmp/project-context.md
          echo "Code files found: $FILE_COUNT" >> /tmp/project-context.md
          echo "" >> /tmp/project-context.md

          # Include README
          if [ -f README.md ]; then
            echo "### README" >> /tmp/project-context.md
            head -100 README.md >> /tmp/project-context.md
            echo "" >> /tmp/project-context.md
          fi

          # Include package.json or similar
          if [ -f package.json ]; then
            echo "### package.json" >> /tmp/project-context.md
            cat package.json >> /tmp/project-context.md
          elif [ -f requirements.txt ]; then
            echo "### requirements.txt" >> /tmp/project-context.md
            cat requirements.txt >> /tmp/project-context.md
          elif [ -f Cargo.toml ]; then
            echo "### Cargo.toml" >> /tmp/project-context.md
            cat Cargo.toml >> /tmp/project-context.md
          elif [ -f go.mod ]; then
            echo "### go.mod" >> /tmp/project-context.md
            cat go.mod >> /tmp/project-context.md
          fi
          echo "" >> /tmp/project-context.md

          # Directory structure
          echo "### Project Structure" >> /tmp/project-context.md
          find . -type f \( -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.go" -o -name "*.rs" -o -name "*.java" -o -name "*.sol" \) | head -50 >> /tmp/project-context.md

          cat /tmp/project-context.md

      - name: Setup Antfarm
        run: |
          git clone https://github.com/snarktank/antfarm.git /tmp/antfarm
          cd /tmp/antfarm && npm install && npm run build && npm link

      - name: Run Bug Fix
        run: |
          cd ${{ github.workspace }}

          CONTEXT=$(cat /tmp/project-context.md)
          ISSUE_BODY="${{ github.event.issue.body }}"

          if [ "${{ steps.context.outputs.has_code }}" == "true" ]; then
            PROMPT="Fix issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

Issue Description:
$ISSUE_BODY

IMPORTANT: This repository has existing code. You MUST:
1. Analyze the existing codebase structure and patterns
2. Follow the existing coding style, naming conventions, and architecture
3. Use the same libraries/frameworks already in use
4. Add tests if the project has tests
5. Update documentation if needed

Project Context:
$CONTEXT"
          else
            PROMPT="Fix issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

Issue Description:
$ISSUE_BODY

NOTE: This appears to be a new/empty repository. Create a proper project structure based on the repository name and issue requirements."
          fi

          antfarm workflow run bug-fix "$PROMPT"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.MANUS_API_KEY }}
          OPENAI_API_BASE: https://api.manus.ai/v1

  # AUTO-IMPLEMENT FEATURES
  auto-feature:
    if: github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'enhancement'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Analyze Project Context
        id: context
        run: |
          echo "## Project Analysis" > /tmp/project-context.md
          echo "" >> /tmp/project-context.md

          FILE_COUNT=$(find . -type f \( -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.go" -o -name "*.rs" -o -name "*.java" -o -name "*.cpp" -o -name "*.c" -o -name "*.sol" \) | head -100 | wc -l)
          echo "has_code=$([[ $FILE_COUNT -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

          echo "### Repository: ${{ github.repository }}" >> /tmp/project-context.md
          echo "Code files found: $FILE_COUNT" >> /tmp/project-context.md
          echo "" >> /tmp/project-context.md

          if [ -f README.md ]; then
            echo "### README" >> /tmp/project-context.md
            head -100 README.md >> /tmp/project-context.md
            echo "" >> /tmp/project-context.md
          fi

          if [ -f package.json ]; then
            echo "### package.json" >> /tmp/project-context.md
            cat package.json >> /tmp/project-context.md
          elif [ -f requirements.txt ]; then
            echo "### requirements.txt" >> /tmp/project-context.md
            cat requirements.txt >> /tmp/project-context.md
          elif [ -f Cargo.toml ]; then
            echo "### Cargo.toml" >> /tmp/project-context.md
            cat Cargo.toml >> /tmp/project-context.md
          elif [ -f go.mod ]; then
            echo "### go.mod" >> /tmp/project-context.md
            cat go.mod >> /tmp/project-context.md
          fi
          echo "" >> /tmp/project-context.md

          echo "### Project Structure" >> /tmp/project-context.md
          find . -type f \( -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.go" -o -name "*.rs" -o -name "*.java" -o -name "*.sol" \) | head -50 >> /tmp/project-context.md

          cat /tmp/project-context.md

      - name: Setup Antfarm
        run: |
          git clone https://github.com/snarktank/antfarm.git /tmp/antfarm
          cd /tmp/antfarm && npm install && npm run build && npm link

      - name: Run Feature Dev
        run: |
          cd ${{ github.workspace }}

          CONTEXT=$(cat /tmp/project-context.md)
          ISSUE_BODY="${{ github.event.issue.body }}"

          if [ "${{ steps.context.outputs.has_code }}" == "true" ]; then
            PROMPT="Implement feature #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

Feature Request:
$ISSUE_BODY

IMPORTANT: This repository has existing code. You MUST:
1. Analyze the existing codebase structure and patterns
2. Follow the existing coding style, naming conventions, and architecture
3. Use the same libraries/frameworks already in use
4. Integrate seamlessly with existing code
5. Add tests following the project's testing patterns
6. Update documentation if needed

Project Context:
$CONTEXT"
          else
            PROMPT="Implement feature #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

Feature Request:
$ISSUE_BODY

NOTE: This is a new/empty repository. Based on the repository name '${{ github.repository }}':
1. Create a proper project structure
2. Choose appropriate technology stack
3. Implement the requested feature
4. Add README with setup instructions
5. Add basic tests"
          fi

          antfarm workflow run feature-dev "$PROMPT"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.MANUS_API_KEY }}
          OPENAI_API_BASE: https://api.manus.ai/v1

  # SECURITY AUDIT
  security-audit:
    if: github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'security'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Analyze Project Context
        run: |
          echo "## Security Audit Context" > /tmp/project-context.md

          if [ -f README.md ]; then
            echo "### README" >> /tmp/project-context.md
            head -50 README.md >> /tmp/project-context.md
          fi

          echo "### Project Structure" >> /tmp/project-context.md
          find . -type f \( -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.go" -o -name "*.sol" \) | head -50 >> /tmp/project-context.md

          echo "### Dependencies" >> /tmp/project-context.md
          [ -f package.json ] && cat package.json >> /tmp/project-context.md
          [ -f requirements.txt ] && cat requirements.txt >> /tmp/project-context.md
          [ -f Cargo.toml ] && cat Cargo.toml >> /tmp/project-context.md

          cat /tmp/project-context.md

      - name: Setup Antfarm
        run: |
          git clone https://github.com/snarktank/antfarm.git /tmp/antfarm
          cd /tmp/antfarm && npm install && npm run build && npm link

      - name: Run Security Audit
        run: |
          cd ${{ github.workspace }}

          CONTEXT=$(cat /tmp/project-context.md)
          ISSUE_BODY="${{ github.event.issue.body }}"

          PROMPT="Security Audit for #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

Issue Description:
$ISSUE_BODY

Audit the codebase for:
1. OWASP Top 10 vulnerabilities
2. Dependency vulnerabilities
3. Secrets/credentials in code
4. Injection vulnerabilities (SQL, XSS, Command)
5. Authentication/Authorization issues
6. Cryptographic weaknesses

Project Context:
$CONTEXT"

          antfarm workflow run security-audit "$PROMPT"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.MANUS_API_KEY }}
          OPENAI_API_BASE: https://api.manus.ai/v1
