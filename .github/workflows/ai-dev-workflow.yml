name: AI Development Assistant

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      task:
        description: 'Task to run'
        required: true
        default: 'review'

env:
  # Using Manus AI (OpenAI-compatible)
  OPENAI_API_KEY: ${{ secrets.MANUS_API_KEY }}
  OPENAI_API_BASE: https://api.manus.ai/v1
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # PR REVIEW
  pr-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PR-Agent
        run: pip install pr-agent

      - name: PR-Agent Review
        run: |
          pr-agent --pr_url=${{ github.event.pull_request.html_url }} review
        env:
          OPENAI_API_KEY: ${{ secrets.MANUS_API_KEY }}
          OPENAI_API_BASE: https://api.manus.ai/v1

      - name: PR-Agent Improve
        run: |
          pr-agent --pr_url=${{ github.event.pull_request.html_url }} improve
        env:
          OPENAI_API_KEY: ${{ secrets.MANUS_API_KEY }}
          OPENAI_API_BASE: https://api.manus.ai/v1

  # ISSUE AUTO-LABEL
  issue-triage:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Auto-Label Issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = (issue.body || '').toLowerCase();
            const title = (issue.title || '').toLowerCase();

            const labels = [];
            if (title.includes('bug') || body.includes('error') || body.includes('crash')) {
              labels.push('bug');
            }
            if (title.includes('feature') || body.includes('request') || body.includes('add')) {
              labels.push('enhancement');
            }
            if (body.includes('security') || body.includes('vulnerability') || body.includes('cve')) {
              labels.push('security');
            }

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labels
              });
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `ðŸ¤– **AI Assistant**: Analyzing this issue...\n\nLabels: ${labels.join(', ') || 'analyzing...'}\n\n_I'll work on this automatically if it's a bug, feature request, or security issue._`
            });

  # AUTO-FIX BUGS
  auto-fix-bug:
    if: github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'bug'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup Antfarm
        run: |
          git clone https://github.com/snarktank/antfarm.git /tmp/antfarm
          cd /tmp/antfarm && npm install && npm run build && npm link

      - name: Run Bug Fix
        run: |
          cd ${{ github.workspace }}
          antfarm workflow run bug-fix "Fix issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.MANUS_API_KEY }}
          OPENAI_API_BASE: https://api.manus.ai/v1

  # AUTO-IMPLEMENT FEATURES
  auto-feature:
    if: github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'enhancement'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup Antfarm
        run: |
          git clone https://github.com/snarktank/antfarm.git /tmp/antfarm
          cd /tmp/antfarm && npm install && npm run build && npm link

      - name: Run Feature Dev
        run: |
          cd ${{ github.workspace }}
          antfarm workflow run feature-dev "Implement #${{ github.event.issue.number }}: ${{ github.event.issue.title }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.MANUS_API_KEY }}
          OPENAI_API_BASE: https://api.manus.ai/v1

  # SECURITY AUDIT
  security-audit:
    if: github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'security'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup Antfarm
        run: |
          git clone https://github.com/snarktank/antfarm.git /tmp/antfarm
          cd /tmp/antfarm && npm install && npm run build && npm link

      - name: Run Security Audit
        run: |
          cd ${{ github.workspace }}
          antfarm workflow run security-audit "Security #${{ github.event.issue.number }}: ${{ github.event.issue.title }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.MANUS_API_KEY }}
          OPENAI_API_BASE: https://api.manus.ai/v1
